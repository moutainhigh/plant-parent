<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.moguying.plant.core.dao.account.UserMoneyLogDAO">
  <resultMap id="BaseResultMap" type="com.moguying.plant.core.entity.dto.UserMoneyLog">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="user_id" jdbcType="INTEGER" property="userId" />
    <result column="affect_money" jdbcType="DECIMAL" property="affectMoney" />
    <result column="available_money" jdbcType="DECIMAL" property="availableMoney" />
    <result column="freeze_money" jdbcType="DECIMAL" property="freezeMoney" />
    <result column="collect_money" jdbcType="DECIMAL" property="collectMoney" />
    <result column="collect_capital" jdbcType="DECIMAL" property="collectCapital" />
    <result column="collect_interest" jdbcType="DECIMAL" property="collectInterest" />
    <result column="affect_type" jdbcType="TINYINT" property="affectType" />
    <result column="affect_time" jdbcType="TIMESTAMP" property="affectTime" />
    <result column="affect_ip" jdbcType="VARCHAR" property="affectIp" />
    <result column="detail_id" jdbcType="VARCHAR" property="detailId" />
    <result column="affect_info" jdbcType="VARCHAR" property="affectInfo" />
  </resultMap>
  
  <resultMap id="BaseInfoMap" type="com.moguying.plant.core.entity.dto.UserMoneyLog" extends="BaseResultMap">
    <result column="phone" property="phone" jdbcType="VARCHAR"/>
    <result column="real_name" property="realName" jdbcType="VARCHAR"/>
  </resultMap>
  
  <sql id="Base_Column_List">
    id, user_id, affect_money, available_money, freeze_money, collect_money, collect_capital, 
    collect_interest, affect_type, affect_time, affect_ip, detail_id, affect_info
  </sql>

  <insert id="insert" parameterType="com.moguying.plant.core.entity.dto.UserMoneyLog">
    insert into plant_user_money_log
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="userId != null">
        user_id,
      </if>
      <if test="affectMoney != null">
        affect_money,
      </if>
      <if test="availableMoney != null">
        available_money,
      </if>
      <if test="freezeMoney != null">
        freeze_money,
      </if>
      <if test="collectMoney != null">
        collect_money,
      </if>
      <if test="collectCapital != null">
        collect_capital,
      </if>
      <if test="collectInterest != null">
        collect_interest,
      </if>
      <if test="affectType != null">
        affect_type,
      </if>
      <if test="affectTime != null">
        affect_time,
      </if>
      <if test="affectIp != null">
        affect_ip,
      </if>
      <if test="detailId != null">
        detail_id,
      </if>
      <if test="affectInfo != null">
        affect_info,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=BIGINT},
      </if>
      <if test="userId != null">
        #{userId,jdbcType=INTEGER},
      </if>
      <if test="affectMoney != null">
        #{affectMoney,jdbcType=DECIMAL},
      </if>
      <if test="availableMoney != null">
        #{availableMoney,jdbcType=DECIMAL},
      </if>
      <if test="freezeMoney != null">
        #{freezeMoney,jdbcType=DECIMAL},
      </if>
      <if test="collectMoney != null">
        #{collectMoney,jdbcType=DECIMAL},
      </if>
      <if test="collectCapital != null">
        #{collectCapital,jdbcType=DECIMAL},
      </if>
      <if test="collectInterest != null">
        #{collectInterest,jdbcType=DECIMAL},
      </if>
      <if test="affectType != null">
        #{affectType,jdbcType=TINYINT},
      </if>
      <if test="affectTime != null">
        #{affectTime,jdbcType=TIMESTAMP},
      </if>
      <if test="affectIp != null">
        #{affectIp,jdbcType=VARCHAR},
      </if>
      <if test="detailId != null">
        #{detailId,jdbcType=INTEGER},
      </if>
      <if test="affectInfo != null">
        #{affectInfo,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateById" parameterType="com.moguying.plant.core.entity.dto.UserMoneyLog">
    update plant_user_money_log
    <set>
      <if test="userId != null">
        user_id = #{userId,jdbcType=INTEGER},
      </if>
      <if test="affectMoney != null">
        affect_money = #{affectMoney,jdbcType=DECIMAL},
      </if>
      <if test="availableMoney != null">
        available_money = #{availableMoney,jdbcType=DECIMAL},
      </if>
      <if test="freezeMoney != null">
        freeze_money = #{freezeMoney,jdbcType=DECIMAL},
      </if>
      <if test="collectMoney != null">
        collect_money = #{collectMoney,jdbcType=DECIMAL},
      </if>
      <if test="collectCapital != null">
        collect_capital = #{collectCapital,jdbcType=DECIMAL},
      </if>
      <if test="collectInterest != null">
        collect_interest = #{collectInterest,jdbcType=DECIMAL},
      </if>
      <if test="affectType != null">
        affect_type = #{affectType,jdbcType=TINYINT},
      </if>
      <if test="affectTime != null">
        affect_time = #{affectTime,jdbcType=TIMESTAMP},
      </if>
      <if test="affectIp != null">
        affect_ip = #{affectIp,jdbcType=VARCHAR},
      </if>
      <if test="detailId != null">
        detail_id = #{detailId,jdbcType=VARCHAR},
      </if>
      <if test="affectInfo != null">
        affect_info = #{affectInfo,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>

  <select id="selectSelective" resultMap="BaseInfoMap">
    select  t1.id, user_id, affect_money, available_money, freeze_money, collect_money, collect_capital,
    collect_interest, affect_type, affect_time, affect_ip, detail_id, affect_info,t2.phone,t2.real_name from plant_user_money_log t1
    left join plant_user t2 on t1.user_id = t2.id
    <where>
        <if test="userId != null">
          user_id = #{userId}
        </if>
        <if test="'' != phone and phone != null">
          <bind name="phoneLike" value="'%'+ phone +'%'"/>
          AND t2.phone like #{phoneLike}
        </if>
      <if test="realName != null and realName != ''">
        <bind name="realNameLike" value="'%'+ realName +'%'"/>
        AND t2.real_name like #{realNameLike}
      </if>
        <if test="affectType != null">
          AND affect_type = #{affectType}
        </if>

        <if test="startTime != null">
          <![CDATA[
            AND UNIX_TIMESTAMP(affect_time) <= UNIX_TIMESTAMP(#{startTime})
          ]]>
        </if>
        <if test="endTime != null">
          <![CDATA[
              AND UNIX_TIMESTAMP(affect_time) <= UNIX_TIMESTAMP(#{endTime})
            ]]>
        </if>
        <if test="detailId != null and detailId != ''">
          AND detail_id = #{detailId}
        </if>

    </where>
    order by id desc
  </select>

  <select id="fieldSumByTypeUserId" resultType="java.math.BigDecimal">
    select COALESCE(sum(ABS(${field})),0) from plant_user_money_log
    <where>
      <if test="userId != null">
        user_id = #{userId}
      </if>
      <if test="types != null">
        AND affect_type in
        <foreach collection="types" open="(" close=")" separator="," item="item">
          #{item.type}
        </foreach>
      </if>
      <if test="startTime != null and endTime != null">
        <![CDATA[
        AND affect_time >= #{startTime} AND affect_time <= #{endTime}
        ]]>
      </if>
    </where>



  </select>
  


</mapper>