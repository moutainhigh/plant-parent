<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.moguying.plant.core.dao.mall.MallOrderDAO">

    <resultMap id="BaseResultMap" type="com.moguying.plant.core.entity.dto.MallOrder">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="order_number" jdbcType="VARCHAR" property="orderNumber"/>
        <result column="user_id" jdbcType="INTEGER" property="userId"/>
        <result column="total_coins" jdbcType="INTEGER" property="totalCoins"/>
        <result column="buy_amount" jdbcType="DECIMAL" property="buyAmount"/>
        <result column="buy_mark" jdbcType="VARCHAR" property="buyMark"/>
        <result column="fee_amount" jdbcType="DECIMAL" property="feeAmount"/>
        <result column="state" jdbcType="TINYINT" property="state"/>
        <result column="address_id" jdbcType="INTEGER" property="addressId"/>
        <result column="add_time" jdbcType="TIMESTAMP" property="addTime"/>
        <result column="pay_time" jdbcType="TIMESTAMP" property="payTime"/>
        <result column="close_time" jdbcType="TIMESTAMP" property="closeTime"/>
        <result column="send_time" jdbcType="TIMESTAMP" property="sendTime"/>
        <result column="notice_time" jdbcType="TIMESTAMP" property="noticeTime"/>
        <result column="is_notice" jdbcType="BIT" property="isNotice"/>
        <result column="confirm_time" jdbcType="TIMESTAMP" property="confirmTime"/>
        <result column="express_order_number" jdbcType="VARCHAR" property="expressOrderNumber"/>
        <result column="express_com_code" jdbcType="VARCHAR" property="expressComCode"/>
        <result column="cancel_reason" jdbcType="VARCHAR" property="cancelReason"/>
        <result column="seq_no" jdbcType="VARCHAR" property="seqNo"/>
        <result column="car_pay_amount" jdbcType="DECIMAL" property="carPayAmount"/>
        <result column="account_pay_amount" jdbcType="DECIMAL" property="accountPayAmount"/>
        <result column="reduce_pay_amount" jdbcType="DECIMAL" property="reducePayAmount"/>
    </resultMap>

    <resultMap id="BaseResultMalWithUserPhone" type="com.moguying.plant.core.entity.dto.MallOrder"
               extends="BaseResultMap">
        <result column="phone" jdbcType="INTEGER" property="phone"/>
        <result column="real_name" jdbcType="INTEGER" property="realName"/>
    </resultMap>

    <resultMap id="OrderListMap" type="com.moguying.plant.core.entity.vo.UserMallOrder">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="add_time" jdbcType="TIMESTAMP" property="addTime"/>
        <result column="state" jdbcType="TINYINT" property="state"/>
        <result column="buy_amount" jdbcType="DECIMAL" property="buyAmount"/>
        <result column="total_coins" jdbcType="INTEGER" property="totalCoins"/>
        <result column="fee_amount" jdbcType="DECIMAL" property="feeAmount"/>
        <result column="total_amount" jdbcType="DECIMAL" property="totalAmount"/>
        <result column="is_notice" jdbcType="BIT" property="isNotice"/>

    </resultMap>

    <sql id="Base_Column_List">
    id, order_number, user_id, buy_amount, total_coins, buy_mark, fee_amount, `state`, address_id,
    add_time, pay_time, close_time, send_time, is_notice, confirm_time, express_order_number, express_com_code,
    cancel_reason, seq_no,car_pay_amount,account_pay_amount,reduce_pay_amount,notice_time
  </sql>


    <insert id="insert" parameterType="com.moguying.plant.core.entity.dto.MallOrder" useGeneratedKeys="true"
            keyProperty="id">
        insert into plant_mall_order
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="orderNumber != null">
                order_number,
            </if>
            <if test="userId != null">
                user_id,
            </if>
            <if test="buyAmount != null">
                buy_amount,
            </if>
            <if test="totalCoins != null">
                total_coins,
            </if>
            <if test="buyMark != null">
                buy_mark,
            </if>
            <if test="feeAmount != null">
                fee_amount,
            </if>
            <if test="state != null">
                `state`,
            </if>
            <if test="addressId != null">
                address_id,
            </if>
            <if test="addTime != null">
                add_time,
            </if>
            <if test="payTime != null">
                pay_time,
            </if>
            <if test="closeTime != null">
                close_time,
            </if>
            <if test="sendTime != null">
                send_time,
            </if>
            <if test="isNotice != null">
                is_notice,
            </if>
            <if test="confirmTime != null">
                confirm_time,
            </if>
            <if test="expressOrderNumber != null">
                express_order_number,
            </if>
            <if test="expressComCode != null">
                express_com_code,
            </if>
            <if test="cancelReason != null">
                cancel_reason,
            </if>
            <if test="seqNo != null">
                seq_no,
            </if>
            <if test="carPayAmount != null">
                car_pay_amount,
            </if>
            <if test="accountPayAmount != null">
                account_pay_amount,
            </if>
            <if test="reducePayAmount != null">
                reduce_pay_amount,
            </if>
            <if test="noticeTime != null">
                notice_time,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="orderNumber != null">
                #{orderNumber,jdbcType=VARCHAR},
            </if>
            <if test="userId != null">
                #{userId,jdbcType=INTEGER},
            </if>
            <if test="buyAmount != null">
                #{buyAmount,jdbcType=DECIMAL},
            </if>
            <if test="totalCoins != null">
                #{totalCoins},
            </if>
            <if test="buyMark != null">
                #{buyMark,jdbcType=VARCHAR},
            </if>
            <if test="feeAmount != null">
                #{feeAmount,jdbcType=DECIMAL},
            </if>
            <if test="state != null">
                #{state,jdbcType=TINYINT},
            </if>
            <if test="addressId != null">
                #{addressId,jdbcType=INTEGER},
            </if>
            <if test="addTime != null">
                #{addTime,jdbcType=TIMESTAMP},
            </if>
            <if test="payTime != null">
                #{payTime,jdbcType=TIMESTAMP},
            </if>
            <if test="closeTime != null">
                #{closeTime,jdbcType=TIMESTAMP},
            </if>
            <if test="sendTime != null">
                #{sendTime,jdbcType=TIMESTAMP},
            </if>
            <if test="isNotice != null">
                #{isNotice,jdbcType=BIT},
            </if>
            <if test="confirmTime != null">
                #{confirmTime,jdbcType=TIMESTAMP},
            </if>
            <if test="expressOrderNumber != null">
                #{expressOrderNumber,jdbcType=VARCHAR},
            </if>
            <if test="expressComCode != null">
                #{expressComCode,jdbcType=VARCHAR},
            </if>
            <if test="cancelReason != null">
                #{cancelReason,jdbcType=VARCHAR},
            </if>
            <if test="seqNo != null">
                #{seqNo,jdbcType=VARCHAR},
            </if>
            <if test="carPayAmount != null">
                #{carPayAmount,jdbcType=DECIMAL},
            </if>
            <if test="accountPayAmount != null">
                #{accountPayAmount,jdbcType=DECIMAL},
            </if>
            <if test="reducePayAmount != null">
                #{reducePayAmount,jdbcType=DECIMAL},
            </if>
            <if test="noticeTime != null">
                #{noticeTime,jdbcType=TIMESTAMP},
            </if>
        </trim>
    </insert>

    <update id="updateById" parameterType="com.moguying.plant.core.entity.dto.MallOrder">
        update plant_mall_order
        <set>
            <if test="orderNumber != null">
                order_number = #{orderNumber,jdbcType=VARCHAR},
            </if>
            <if test="userId != null">
                user_id = #{userId,jdbcType=INTEGER},
            </if>
            <if test="buyAmount != null">
                buy_amount = #{buyAmount,jdbcType=DECIMAL},
            </if>
            <if test="totalCoins != null">
                total_coins = #{totalCoins},
            </if>
            <if test="buyMark != null">
                buy_mark = #{buyMark,jdbcType=VARCHAR},
            </if>
            <if test="feeAmount != null">
                fee_amount = #{feeAmount,jdbcType=DECIMAL},
            </if>
            <if test="state != null">
                `state` = #{state,jdbcType=TINYINT},
            </if>
            <if test="addressId != null">
                address_id = #{addressId,jdbcType=INTEGER},
            </if>
            <if test="addTime != null">
                add_time = #{addTime,jdbcType=TIMESTAMP},
            </if>
            <if test="payTime != null">
                pay_time = #{payTime,jdbcType=TIMESTAMP},
            </if>
            <if test="closeTime != null">
                close_time = #{closeTime,jdbcType=TIMESTAMP},
            </if>
            <if test="sendTime != null">
                send_time = #{sendTime,jdbcType=TIMESTAMP},
            </if>
            <if test="isNotice != null">
                is_notice = #{isNotice,jdbcType=BIT},
            </if>
            <if test="confirmTime != null">
                confirm_time = #{confirmTime,jdbcType=TIMESTAMP},
            </if>
            <if test="expressOrderNumber != null">
                express_order_number = #{expressOrderNumber,jdbcType=VARCHAR},
            </if>
            <if test="expressComCode != null">
                express_com_code = #{expressComCode,jdbcType=VARCHAR},
            </if>
            <if test="cancelReason != null">
                cancel_reason = #{cancelReason,jdbcType=VARCHAR},
            </if>
            <if test="seqNo != null">
                seq_no = #{seqNo,jdbcType=VARCHAR},
            </if>
            <if test="carPayAmount != null">
                car_pay_amount = #{carPayAmount,jdbcType=DECIMAL},
            </if>
            <if test="accountPayAmount != null">
                account_pay_amount = #{accountPayAmount,jdbcType=DECIMAL},
            </if>
            <if test="reducePayAmount != null">
                reduce_pay_amount = #{reducePayAmount,jdbcType=DECIMAL},
            </if>
            <if test="noticeTime != null">
                notice_time = #{noticeTime,jdbcType=TIMESTAMP},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>

    <select id="userOrderListByState" resultMap="OrderListMap">
        select id,add_time,fee_amount,buy_amount,state,sum(buy_amount + fee_amount) as total_amount,is_notice, total_coins
        from plant_mall_order
        where user_id = #{userId}
        <choose>
            <when test="state != null">
                AND state = #{state}
            </when>
            <otherwise>
                <![CDATA[
            AND state <> 4
        ]]>
            </otherwise>
        </choose>
        group by id
        order by add_time desc
    </select>

    <select id="selectSelective" resultMap="BaseResultMalWithUserPhone">
        select
        t1.id,order_number,buy_amount,buy_mark,fee_amount,t1.state,t1.add_time,pay_time,send_time,is_notice,express_order_number,
        car_pay_amount,account_pay_amount,reduce_pay_amount,t2.phone,t2.real_name from plant_mall_order t1
        left join plant_user t2 on t1.user_id = t2.id
        <where>
            <if test="orderNumber != null and orderNumber != '' ">
                order_number = #{orderNumber}
            </if>
            <if test="phone != null and phone != '' ">
                AND t2.phone = #{phone}
            </if>
            <if test="state != null">
                AND state = #{state}
            </if>
        </where>
        order by add_time desc,notice_time desc
    </select>

    <select id="findByIdAndNum" resultMap="BaseResultMap">
        select <include refid="Base_Column_List"/>
        from plant_mall_order
        <where>
            user_id = #{userId}
            and order_number = #{number}
        </where>
    </select>

</mapper>